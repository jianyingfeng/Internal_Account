- config:
    name: 手机号注册
    base_url: ${tiger_api_host()}
    variables:
        - unregistered_phone_number: ${test_phone_number()}
        - wrong_captcha: '123456'
        - correct_password: m1234567
        - exist_pid: UvOFXx2tfv

- test:
    name: 发送注册验证码：手机号未注册
    skipUnless: ${is_dev_or_test()}
    setup_hooks:
        - ${clear_phone_number($unregistered_phone_number)}
    api: api/account/v3_for_web/send_register_captcha.yaml
    variables:
        - ticket: ${get_captcha_ticket()}
        - phone_number: $unregistered_phone_number
    validate:
        - eq: [status_code, 204]

- test:
    name: 手机号未注册-验证码错误-密码格式正确
    skipUnless: ${is_dev_or_test()}
    request:
        method: POST
        url: /tiger/v3/web/accounts/register/phone
        json:
            phone_number: $unregistered_phone_number
            captcha: $wrong_captcha
            password: $correct_password
            pid: $exist_pid
    validate:
        - eq: [status_code, 403]
        - eq: [content.error_code, AC3_13]

- test:
    name: 手机号未注册-验证码正确-密码不传递
    skipUnless: ${is_dev_or_test()}
    request:
        method: POST
        url: /tiger/v3/web/accounts/register/phone
        json:
            phone_number: $unregistered_phone_number
            captcha: ${get_captcha_account_v3(register, $unregistered_phone_number)}
            pid: $exist_pid
    validate:
        - eq: [status_code, 400]
        - eq: [content.error_code, A_5]

- test:
    name: 手机号未注册-验证码正确-密码格式正确
    skipUnless: ${is_dev_or_test()}
    request:
        method: POST
        url: /tiger/v3/web/accounts/register/phone
        json:
            phone_number: $unregistered_phone_number
            captcha: ${get_captcha_account_v3(register, $unregistered_phone_number)}
            password: $correct_password
            pid: $exist_pid
    validate:
        - eq: [status_code, 200]
        - length_equals: [content.user_info, 8]
        - contains: [content.user_info, id]
        - contains: [content.user_info, nickname]
        - contains: [content.user_info, avatar_url]
        - contains: [content.user_info, sex]
        - eq: [content.auth.has_password, True]
    extract:
        - registered_user_id: content.user_info.id

- test:
    name: 验证手机号注册成功后，使用手机号+密码登录成功
    skipUnless: ${is_dev_or_test()}
    api: api/account/account_login.yaml
    variables:
        - identity: $unregistered_phone_number
        - password: $correct_password
    validate:
        - eq: [status_code, 200]
        - eq: [content.user_info.id, $registered_user_id]


