- config:
    name: 账号密码登录
    base_url: ${tiger_api_host()}
    variables:
        - existed_pid: unknown
        - wrong_password_source_user: abc

# 旧登录态
- test:
    name: 用户名已注册-密码正确-不传递auth_version
    request:
        method: POST
        url: /tiger/v3/web/accounts/login
        json:
            identity: ${source_user_username()}
            password: ${source_user_password()}
            pid: $existed_pid
    validate:
        - eq: [status_code, 200]
        - eq: [content.user_info.id, '${source_user_id()}']
    extract:
        - user_login_old_token: content.auth.token

- test:
    name: 验证：登录成功后，可以旧登录态正常获取用户信息
    request:
        url: /tiger/v3/web/accounts/privacy
        method: GET     
        headers:
            Authorization: Bearer $user_login_old_token
    validate:
        - eq: [status_code, 200]
        - eq: [content.username, '${source_user_username()}']
        - eq: [content.has_password, true]
        - contains: [content, email]
        - contains: [content, phone_number]
        - length_equals: [content, 4]

- test:
    name: 邮箱已注册-密码正确
    request:
        method: POST
        url: /tiger/v3/web/accounts/login
        json:
            identity: ${source_user_email()}
            password: ${source_user_password()}
            pid: $existed_pid
    validate:
        - eq: [status_code, 200]
        - eq: [content.user_info.id, '${source_user_id()}']

- test:
    name: 用户名已注册-密码错误
    request:
        method: POST
        url: /tiger/v3/web/accounts/login
        json:
            identity: ${source_user_username()}
            password: $wrong_password_source_user
            pid: $existed_pid
    validate:
        - eq: [status_code, 403]
        - eq: [content.error_code, AC3_2]

- test:
    name: 用户名已注册-密码不传递
    request:
        method: POST
        url: /tiger/v3/web/accounts/login
        json:
            identity: ${source_user_username()}
            pid: $existed_pid
    validate:
        - eq: [status_code, 400]
        - eq: [content.error_code, A_5]

# 新登录态
- test:
    name: 用户名已注册-密码正确-传递auth_version
    request:
        method: POST
        url: /tiger/v3/web/accounts/login
        json:
            auth_version: '1.0.0'
            identity: ${source_user_username()}
            password: ${source_user_password()}
            pid: $existed_pid
    validate:
        - eq: [status_code, 200]
        - eq: [content.user_info.id, '${source_user_id()}']
    extract:
        - user_login_new_token: content.auth.token.access.token

- test:
    name: 验证：登录成功后，可以新登录态正常获取用户信息
    request:
        url: /tiger/v3/web/accounts/privacy
        method: GET     
        headers:
            Authorization: Bearer $user_login_new_token
    validate:
        - eq: [status_code, 200]
        - eq: [content.username, '${source_user_username()}']
        - eq: [content.has_password, true]
        - contains: [content, email]
        - contains: [content, phone_number]
        - length_equals: [content, 4]

- test:
    name: 用户名已注册-密码正确-pid不传递
    request:
        method: POST
        url: /tiger/v3/web/accounts/login
        json:
            identity: ${source_user_username()}
            password: ${source_user_password()}
    validate:
        - eq: [status_code, 400]
        - eq: [content.error_code, A_5]