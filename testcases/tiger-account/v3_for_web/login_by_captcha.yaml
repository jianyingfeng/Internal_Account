- config:
    name: 验证码登录（非静默注册版本）
    base_url: ${tiger_api_host()}
    variables:
        - unregister_phone_number: ${test_phone_number()}
        - wrong_captcha: '123456'
        - existed_pid: unknown

- test:
    name: 准备1：注册手机号
    skipUnless: ${is_dev_or_test()}
    setup_hooks:
        - ${clear_phone_number($unregister_phone_number)}
    api: api/platform-user-tiger/register_phone_number.yaml
    variables:
        - phone_number: $unregister_phone_number
    validate:
        - eq: [status_code, 200]

- test:
    name: 准备2：发送登录验证码（非静默注册版本）
    skipUnless: ${is_dev_or_test()}
    api: api/account/v3_for_web/send_login_captcha.yaml
    variables:
        - phone_number: $unregister_phone_number
    validate:
        - eq: [status_code, 204]

- test:
    name: 手机号已注册-验证码正确
    skipUnless: ${is_dev_or_test()}
    request:
        method: POST
        url: /tiger/v3/web/accounts/phone/login
        json:
            phone_number: $unregister_phone_number
            captcha: ${get_captcha_account_v3(login, $unregister_phone_number)}
            pid: $existed_pid
    validate:
        - eq: [status_code, 200]
    teardown_hooks:
        # 验证：验证码登录成功后，redis中的数据会被清除
        - ${is_none(${get_captcha_account_v3(login, $unregister_phone_number)})}

- test:
    name: 手机号已注册-验证码错误
    skipUnless: ${is_dev_or_test()}
    request:
        method: POST
        url: /tiger/v3/web/accounts/phone/login
        json:
            phone_number: $unregister_phone_number
            captcha: $wrong_captcha
            pid: $existed_pid
    validate:
        - eq: [status_code, 403]
        - eq: [content.error_code, AC3_13]
    teardown_hooks:
        - ${clear_phone_number($unregister_phone_number)}